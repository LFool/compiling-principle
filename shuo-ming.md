# 说明

本系统是使用SpringBoot开发的高并发限时抢购秒杀系统，除了实现基本的登录、查看商品列表、秒杀、下单等功能等，项目中还针对高并发情况实现了系统缓存、降级和限流。

测试环境：1000线程，循环10次，共10000请求，5000用户，同一用户同一商品只能秒杀一次

测试分为三个部分

* 测试未优化的项目，查看吞吐量
* 测试优化过的项目，查看吞吐量
* 添加恶意防刷的功能

优化方法（数据库访问，页面加载）

* 页面缓存 + 对象缓存
  * 页面缓存：把手动渲染得到的html页面缓存到redis
  * 对象缓存：包括对用户信息、商品信息、订单信息和token等数据进行缓存，利用缓存来减少对数据库的访问，大大加快查询速度
* 页面静态化
  * 对商品详情和订单详情进行页面静态化处理，页面是存在html，动态数据是通过接口从服务端获取，实现前后端分离，静态页面无需连接数据库打开速度较动态页面会有明显提高
* 三级缓冲保护：本地标记 + redis预处理 + RabbitMQ异步下单，最后才会访问到数据库
  * 在秒杀阶段使用本地标记对用户秒杀过的商品做标记，若被标记过直接返回重复秒杀，未被标记才查询redis，通过本地标记来减少对redis的访问
  * 抢购开始前，将商品和库存数据同步到redis中，所有的抢购操作都在redis中进行处理，通过Redis预减少库存减少数据库访问
  * 为了保护系统不受高流量的冲击而导致系统崩溃的问题，使用RabbitMQ用异步队列处理下单，实际做了一层缓冲保护，做了一个窗口模型，窗口模型会实时的刷新用户秒杀的状态。

解决超卖

两个用户同时购买同一个库存为1的商品，防止库存变为-1的情况

实现：

1. 对库存更新时，先对库存判断，只有当库存大于0才能更新库存
2. 对用户id和商品id建立一个唯一索引，通过这种约束避免同一用户发同时两个请求秒杀到两件相同商品
3. 实现乐观锁，给商品信息表增加一个version字段，为每一条数据加上版本。每次更新的时候version+1，并且更新时候带上版本号，当提交前版本号等于更新前版本号，说明此时没有被其他线程影响到，正常更新，如果冲突了则不会进行提交更新。当库存是足够的情况下发生乐观锁冲突就进行一定次数的重试。

